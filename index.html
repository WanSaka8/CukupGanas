<!doctype html>
<html lang="id">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VocabSR - Simple Anki-like Spaced Repetition</title>
  <style>
      :root {
      --bg: #0f1724;
      --card: #1e293b;
      --accent: #06b6d4;
      --accent-dark: #0891b2;
      --muted: #94a3b8;
      --text: #e2e8f0;
      --text-light: #f8fafc;
      --glass: rgba(255, 255, 255, 0.04);
      --success: #34d399;
      --warning: #f59e0b;
      --danger: #fb7185;
      --info: #60a5fa;
      --border: rgba(255, 255, 255, 0.08);
      --radius: 12px;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html,
    body {
      height: 100%;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      color: var(--text);
      background: linear-gradient(135deg, #0f1724 0%, #1e293b 100%);
      line-height: 1.5;
      -webkit-tap-highlight-color: transparent;
    }

    .app {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }

    header {
      display: flex;
      gap: 16px;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    h1 {
      margin: 0;
      font-size: 22px;
      font-weight: 600;
      color: var(--text-light);
      background: linear-gradient(90deg, #06b6d4, #34d399);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .muted {
      color: var(--muted);
      font-size: 14px;
      margin-top: 4px;
    }

    .controls {
      margin-left: auto;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    button {
      background: var(--accent);
      border: none;
      color: #022;
      padding: 10px 16px;
      border-radius: var(--radius);
      cursor: pointer;
      font-weight: 500;
      font-size: 14px;
      transition: all 0.2s ease;
      box-shadow: var(--shadow);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    button:active:not(:disabled) {
      transform: scale(0.96);
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
    }

    @media (min-width: 900px) {
      .grid {
        grid-template-columns: 1fr 360px;
      }
    }

    .panel {
      background: rgba(15, 23, 42, 0.7);
      border-radius: var(--radius);
      padding: 18px;
      border: 1px solid var(--border);
      backdrop-filter: blur(8px);
      box-shadow: var(--shadow);
    }

    .deck-list {
      max-height: 400px;
      overflow: auto;
      padding-right: 8px;
    }

    .card-container {
      margin-bottom: 20px;
    }

    .card-preview {
      height: 220px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius);
      background: var(--glass);
      perspective: 1000px;
    }

    .card {
      width: 100%;
      height: 100%;
      position: relative;
      transform-style: preserve-3d;
      transition: transform 0.6s;
      border-radius: var(--radius);
    }

    .card.flipped {
      transform: rotateY(180deg);
    }

    .card-face {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      text-align: center;
    }

    .card-front {
      background: linear-gradient(135deg, rgba(6, 182, 212, 0.1) 0%, rgba(52, 211, 153, 0.1) 100%);
      border: 1px solid rgba(6, 182, 212, 0.3);
    }

    .card-back {
      background: linear-gradient(135deg, rgba(251, 113, 133, 0.1) 0%, rgba(251, 191, 36, 0.1) 100%);
      border: 1px solid rgba(251, 113, 133, 0.3);
      transform: rotateY(180deg);
    }

    .word {
      font-size: 32px;
      font-weight: 600;
      color: var(--text-light);
      margin-bottom: 8px;
    }

    .translation {
      font-size: 20px;
      color: var(--muted);
    }

    .btn-ghost {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px 12px;
      border-radius: var(--radius);
      font-size: 14px;
      transition: all 0.2s ease;
    }

    .btn-ghost:active:not(:disabled) {
      background: rgba(255, 255, 255, 0.05);
    }

    .stats {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    .pill {
      background: rgba(255, 255, 255, 0.05);
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .pill span {
      font-weight: 600;
      color: var(--text-light);
    }

    .study-controls {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-top: 20px;
    }

    .card-actions {
      display: flex;
      gap: 8px;
    }

    .rating-actions {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }

    @media (max-width: 500px) {
      .rating-actions {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .rate-btn {
      padding: 12px 8px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-weight: 500;
      color: white;
      transition: all 0.2s ease;
      font-size: 14px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 60px;
    }

    .rate-btn:active:not(:disabled) {
      transform: scale(0.96);
    }

    .rate-btn small {
      font-size: 11px;
      opacity: 0.8;
      margin-top: 2px;
    }

    .again {
      background: var(--danger);
    }

    .hard {
      background: var(--warning);
    }

    .good {
      background: var(--success);
    }

    .easy {
      background: var(--info);
    }

    footer {
      margin-top: 24px;
      color: var(--muted);
      font-size: 13px;
      text-align: center;
      padding: 12px 0;
    }

    .search {
      width: 100%;
      padding: 10px 14px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.03);
      color: var(--text);
      font-size: 14px;
      margin-bottom: 16px;
      transition: all 0.2s ease;
    }

    .search:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(6, 182, 212, 0.2);
    }

    .list-item {
      padding: 14px;
      border-radius: var(--radius);
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border);
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.2s ease;
    }

    .list-item:active {
      transform: scale(0.98);
    }

    .empty-state {
      text-align: center;
      padding: 20px;
      color: var(--muted);
    }

    /* Add word form */
    .add-word-form {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .add-word-form input {
      flex: 1;
      min-width: 200px;
      padding: 10px 14px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.03);
      color: var(--text);
      font-size: 14px;
    }

    .add-word-form input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(6, 182, 212, 0.2);
    }

    .loading {
      opacity: 0.6;
      pointer-events: none;
    }

    .error-message {
      background: rgba(251, 113, 133, 0.1);
      border: 1px solid rgba(251, 113, 133, 0.3);
      color: var(--danger);
      padding: 12px;
      border-radius: var(--radius);
      margin-bottom: 16px;
      font-size: 14px;
    }

    /* Mobile optimizations */
    @media (max-width: 600px) {
      .app {
        padding: 12px;
      }

      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }

      .controls {
        margin-left: 0;
        width: 100%;
      }

      .controls button {
        flex: 1;
        min-width: 0;
      }

      .card-preview {
        height: 180px;
      }

      .word {
        font-size: 28px;
      }

      .translation {
        font-size: 18px;
      }

      .rate-btn {
        padding: 10px 6px;
        font-size: 13px;
        min-height: 50px;
      }

      .add-word-form {
        flex-direction: column;
      }

      .add-word-form input {
        min-width: auto;
      }
    }

    /* Animation for new card */
    @keyframes cardIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .card-enter {
      animation: cardIn 0.3s ease-out;
    }

    /* Review page styles */
    .review-page {
      display: none;
      padding: 16px;
    }

    .review-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .review-categories {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
      margin-top: 20px;
    }

    @media (min-width: 768px) {
      .review-categories {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .review-category {
      background: rgba(255, 255, 255, 0.03);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      padding: 16px;
    }

    .review-category h3 {
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .review-category .count {
      background: rgba(255, 255, 255, 0.1);
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
    }

    .review-item {
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(255, 255, 255, 0.02);
    }

    .review-item .word {
      font-size: 16px;
      font-weight: 500;
    }

    .review-item .translation {
      font-size: 14px;
    }

    .back-btn {
      background: var(--accent-dark);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: var(--radius);
      cursor: pointer;
    }

    /* New Translator Styles */
    .translator-container {
      margin-top: 20px;
      background: rgba(15, 23, 42, 0.7);
      border-radius: var(--radius);
      padding: 18px;
      border: 1px solid var(--border);
      backdrop-filter: blur(8px);
      box-shadow: var(--shadow);
    }

    .translator-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .translator-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-light);
    }

    .language-selector {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .language-select {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px 12px;
      border-radius: var(--radius);
      font-size: 14px;
      cursor: pointer;
    }

    .swap-btn {
      background: transparent;
      border: none;
      color: var(--muted);
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .swap-btn:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .translator-input {
      width: 100%;
      min-height: 100px;
      padding: 12px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.03);
      color: var(--text);
      font-size: 16px;
      resize: none;
      margin-bottom: 12px;
    }

    .translator-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(6, 182, 212, 0.2);
    }

    .translator-output {
      width: 100%;
      min-height: 100px;
      padding: 12px;
      border-radius: var(--radius);
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border);
      color: var(--text);
      font-size: 16px;
    }

    .translator-footer {
      display: flex;
      justify-content: flex-end;
      margin-top: 8px;
    }

    .translate-btn {
      background: var(--accent);
      color: #022;
      border: none;
      padding: 8px 16px;
      border-radius: var(--radius);
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
    }

    .translate-btn:hover {
      background: var(--accent-dark);
    }

    .translator-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 12px;
      color: var(--muted);
    }

    .translator-error {
      color: var(--danger);
      font-size: 14px;
      margin-top: 8px;
    }

    /* Character counter */
    .char-counter {
      font-size: 12px;
      color: var(--muted);
      text-align: right;
      margin-top: -10px;
      margin-bottom: 8px;
    }

    /* Quality indicator */
    .quality-indicator {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      margin-top: 8px;
    }

    .quality-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--muted);
    }

    .quality-dot.good {
      background: var(--success);
    }

    .quality-dot.fair {
      background: var(--warning);
    }

    .quality-dot.poor {
      background: var(--danger);
    }
  </style>
</head>

<body>
  <div class="app" id="mainPage">
    <header>
      <div>
        <h1>VocabSR — Spaced Repetition</h1>
        <div class="muted">Belajar kosakata dengan teknik pengulangan bertahap</div>
      </div>
      <div class="controls">
        <label for="filein" class="btn-ghost">Import CSV</label>
        <input id="filein" type="file" accept=".csv" style="display:none">
        <button id="export">Export CSV</button>
        <button id="reviewBtn">Tinjau Kembali</button>
        <button id="reset" style="background: var(--danger)">Reset</button>
      </div>
    </header>

    <div class="grid">
      <div class="panel">
        <div class="add-word-form">
          <input id="wordInput" placeholder="Masukkan kata bahasa Inggris..." />
          <button id="addWordBtn">Tambah Kata</button>
        </div>

        <div style="margin-bottom: 12px;">
          <div class="muted" style="font-size: 12px;">
            💡 Tips: Untuk kata yang tidak ditemukan, gunakan format manual: "kata,terjemahan"
          </div>
        </div>

        <div id="errorMessage" class="error-message" style="display: none;"></div>

        <input id="search" class="search" placeholder="Cari kata atau arti..." />

        <div class="stats">
          <div class="pill">Total: <span id="total">0</span></div>
          <div class="pill">Hari ini: <span id="due">0</span></div>
          <div class="pill">Baru: <span id="new">0</span></div>
          <div class="pill">Dipelajari: <span id="studied">0</span></div>
        </div>

        <div class="deck-list" id="list"></div>
      </div>

      <div class="panel">
        <div class="card-container">
          <div class="card-preview">
            <div class="card" id="card">
              <div class="card-face card-front">
                <div class="word" id="front">Siap belajar?</div>
                <div class="translation"></div>
              </div>
              <div class="card-face card-back">
                <div class="word" id="back"></div>
                <div class="translation" id="translation"></div>
              </div>
            </div>
          </div>

          <div class="study-controls">
            <div class="card-actions">
              <button id="flip" class="btn-ghost">Balik (Space)</button>
              <button id="skip" class="btn-ghost">Lewati</button>
              <button id="studyNext" class="btn-ghost" style="background: var(--accent); color: #022;">
                Mulai Belajar
              </button>
            </div>

            <div id="studyPanel" style="display:none">
              <div class="rating-actions">
                <button class="rate-btn again" data-score="0">
                  Lupa
                  <small>(1)</small>
                </button>
                <button class="rate-btn hard" data-score="3">
                  Susah
                  <small>(2)</small>
                </button>
                <button class="rate-btn good" data-score="4">
                  Bagus
                  <small>(3)</small>
                </button>
                <button class="rate-btn easy" data-score="5">
                  Mudah
                  <small>(4)</small>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- New Translator Section -->
        <div class="translator-container">
          <div class="translator-header">
            <div class="translator-title"></div>
            <div class="language-selector">
              <select id="translateFrom" class="language-select">
                <option value="en">English</option>
                <option value="id" selected>Indonesia</option>
              </select>
              <button id="swapLanguages" class="swap-btn" title="Tukar bahasa">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                  stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="17 1 21 5 17 9"></polyline>
                  <path d="M3 11V9a4 4 0 0 1 4-4h14"></path>
                  <polyline points="7 23 3 19 7 15"></polyline>
                  <path d="M21 13v2a4 4 0 0 1-4 4H3"></path>
                </svg>
              </button>
              <select id="translateTo" class="language-select">
                <option value="en" selected>English</option>
                <option value="id">Indonesia</option>
              </select>
            </div>
          </div>

          <textarea id="translateInput" class="translator-input" placeholder="Ketik teks di sini..."></textarea>
          <div id="charCounter" class="char-counter">0/5000 karakter</div>

          <div id="translateOutput" class="translator-output">
            <div style="color: var(--muted);">Terjemahan akan muncul di sini...</div>
          </div>

          <div id="translatorError" class="translator-error" style="display: none;"></div>

          <div class="translator-footer">
            <div id="qualityIndicator" class="quality-indicator" style="display: none;">
              <span>Kualitas terjemahan:</span>
              <div class="quality-dot"></div>
              <span id="qualityText">Sedang</span>
            </div>
            <button id="translateBtn" class="translate-btn">Terjemahkan</button>
          </div>
        </div>
      </div>
    </div>

    <footer>
      <div>© 2025 VocabSR</div>
      <div class="muted">Dibuat untuk belajar bahasa</div>
    </footer>
  </div>

  <!-- Review Page -->
  <div class="app review-page" id="reviewPage">
    <div class="review-header">
      <h1>Tinjau Kembali Kosakata</h1>
      <button class="back-btn" id="backBtn">Kembali</button>
    </div>

    <div class="review-categories" id="reviewCategories">
      <!-- Categories will be populated by JavaScript -->
    </div>

    <footer>
      <div>© 2025 VocabSR</div>
      <div class="muted">Dibuat untuk belajar bahasa</div>
    </footer>
  </div>

  <script type="module">
    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, doc, setDoc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    
    // Your Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDlo2UFN0zO8oI9xDF3YKMeObKvA3poxns",
      authDomain: "nasa-a3871.firebaseapp.com",
      projectId: "nasa-a3871",
      storageBucket: "nasa-a3871.appspot.com",
      messagingSenderId: "109624295870",
      appId: "1:109624295870:web:51070271ce74e2d63879ef",
      measurementId: "G-1L6HPZS3MB"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    // --- Core: simple SM-2 implementation and data management ---
    const STORAGE_KEY = 'vocabsr:deck';
    let deck = [];
    let queue = [];
    let current = null;
    let isLoading = false;

    // API Keys (replace with your own)
    const DEEPL_API_KEY = ''; // Get from https://www.deepl.com/pro#developer
    const GOOGLE_API_KEY = ''; // Get from Google Cloud Console

    // Function to save deck to Firestore
    async function saveToFirestore() {
      try {
        // Clear existing collection (for simplicity, in production you'd want to update individual docs)
        const querySnapshot = await getDocs(collection(db, "vocabulary"));
        const deletePromises = [];
        querySnapshot.forEach((doc) => {
          deletePromises.push(deleteDoc(doc.ref));
        });
        await Promise.all(deletePromises);
        
        // Add all cards to Firestore
        const addPromises = [];
        for (const card of deck) {
          addPromises.push(addDoc(collection(db, "vocabulary"), {
            front: card.front,
            back: card.back,
            id: card.id,
            interval: card.interval,
            repetition: card.repetition,
            ef: card.ef,
            due: card.due,
            easeHistory: card.easeHistory,
            history: card.history,
            category: card.category || null,
            createdAt: new Date().toISOString()
          }));
        }
        await Promise.all(addPromises);
        console.log("Data saved to Firestore");
      } catch (error) {
        console.error("Error saving to Firestore: ", error);
      }
    }

    // Function to load deck from Firestore
    async function loadFromFirestore() {
      try {
        const querySnapshot = await getDocs(collection(db, "vocabulary"));
        deck = [];
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          deck.push({
            front: data.front,
            back: data.back,
            id: data.id,
            interval: data.interval,
            repetition: data.repetition,
            ef: data.ef,
            due: data.due,
            easeHistory: data.easeHistory || [],
            history: data.history || [],
            category: data.category || null
          });
        });
        
        // If no data in Firestore, load from local storage
        if (deck.length === 0) {
          loadFromStorage();
        } else {
          saveToStorage(); // Sync to local storage
          renderAll();
        }
      } catch (error) {
        console.error("Error loading from Firestore: ", error);
        loadFromStorage(); // Fallback to local storage
      }
    }

    function todayDate() {
      const d = new Date();
      d.setHours(0, 0, 0, 0);
      return d.getTime();
    }

    function loadFromStorage() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        try {
          deck = JSON.parse(raw);
          // Initialize missing properties
          deck = deck.map(card => ({
            front: card.front || '',
            back: card.back || '',
            id: card.id || Date.now() + Math.random(),
            interval: card.interval || 0,
            repetition: card.repetition || 0,
            ef: card.ef || 2.5,
            due: card.due || todayDate(),
            easeHistory: card.easeHistory || [],
            history: card.history || [],
            category: card.category || null
          }));
        } catch (e) {
          console.error('Error parsing storage', e);
          deck = [];
          seedSampleDeck();
        }
      } else {
        seedSampleDeck();
      }
    }

    function seedSampleDeck() {
      const sample = [
        ['ask', 'meminta/tanya'],
        ['abandon', 'meninggalkan/mengabaikan']
      ];

      deck = sample.map((s, i) => ({
        front: s[0],
        back: s[1],
        id: i + 1,
        interval: 0,
        repetition: 0,
        ef: 2.5,
        due: todayDate(),
        easeHistory: [],
        history: [],
        category: null
      }));

      saveToStorage();
      saveToFirestore();
    }

    function saveToStorage() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(deck));
    }

    // --- Enhanced Translation Functions ---
    function preprocessText(text) {
      return text
        .replace(/\s+/g, ' ') // rapikan spasi
        .replace(/ ,/g, ',')  // koma nempel
        .replace(/ \./g, '.') // titik nempel
        .trim();
    }

    function enhancedPostProcess(translatedText, originalText) {
      translatedText = postProcessTranslation(translatedText, originalText);

      // Perbaiki kapitalisasi setiap kalimat
      translatedText = translatedText.replace(/(^\s*\w|[.!?]\s*\w)/g, match => match.toUpperCase());

      // Betulin tanda baca ganda (misal .. jadi .)
      translatedText = translatedText.replace(/([.!?])\1+/g, '$1');

      return translatedText;
    }

    async function translateText(text, fromLang, toLang) {
      text = preprocessText(text);
      if (!text.trim()) {
        showTranslatorError('Masukkan teks yang akan diterjemahkan');
        return '';
      }

      // Check if text contains comma (manual format)
      if (text.includes(',')) {
        return text;
      }

      try {
        // 1. Try DeepL API first (if API key available)
        if (DEEPL_API_KEY) {
          try {
            const deeplResponse = await fetchDeeplTranslation(text, fromLang, toLang);
            if (deeplResponse) {
              updateQualityIndicator('good');
              return deeplResponse;
            }
          } catch (e) {
            console.log('DeepL API failed, trying alternatives...');
          }
        }

        // 2. Try Google Cloud Translation (if API key available)
        if (GOOGLE_API_KEY) {
          try {
            const googleResponse = await fetchGoogleCloudTranslation(text, fromLang, toLang);
            if (googleResponse) {
              updateQualityIndicator('good');
              return googleResponse;
            }
          } catch (e) {
            console.log('Google Cloud Translation failed, trying fallback...');
          }
        }

        // 3. Fallback to LibreTranslate
        try {
          const response = await fetch('https://libretranslate.de/translate', {
            method: 'POST',
            body: JSON.stringify({
              q: text,
              source: fromLang,
              target: toLang
            }),
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            }
          });

          if (response.ok) {
            const data = await response.json();
            if (data.translatedText) {
              updateQualityIndicator('fair');
              return postProcessTranslation(data.translatedText, text);
            }
          }
        } catch (e) {
          console.log('LibreTranslate failed, trying MyMemory...');
        }

        // 4. Final fallback to MyMemory
        const myMemoryResponse = await fetchMyMemoryTranslation(text, fromLang, toLang);
        if (myMemoryResponse) {
          updateQualityIndicator(myMemoryResponse.matchScore > 0.8 ? 'fair' : 'poor');
          return myMemoryResponse.translatedText;
        }

        throw new Error('Semua API terjemahan gagal');
      } catch (error) {
        console.error('Translation error:', error);
        throw new Error('Gagal menerjemahkan. Silakan coba lagi atau gunakan format manual.');
      }
    }

    async function fetchDeeplTranslation(text, fromLang, toLang) {
      if (!DEEPL_API_KEY) return null;

      try {
        const response = await fetch('https://api-free.deepl.com/v2/translate', {
          method: 'POST',
          headers: {
            'Authorization': `DeepL-Auth-Key ${DEEPL_API_KEY}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            text: [text],
            source_lang: fromLang.toUpperCase(),
            target_lang: toLang.toUpperCase(),
            preserve_formatting: true,
            formality: 'prefer_more'
          })
        });

        if (response.ok) {
          const data = await response.json();
          return data.translations?.[0]?.text || null;
        }
      } catch (e) {
        console.error('DeepL API error:', e);
        return null;
      }
    }

    async function fetchGoogleCloudTranslation(text, fromLang, toLang) {
      if (!GOOGLE_API_KEY) return null;

      try {
        const response = await fetch(
          `https://translation.googleapis.com/language/translate/v2?key=${GOOGLE_API_KEY}`,
          {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              q: text,
              source: fromLang,
              target: toLang,
              format: 'text',
              model: 'nmt'
            })
          }
        );

        if (response.ok) {
          const data = await response.json();
          return data.data?.translations?.[0]?.translatedText || null;
        }
      } catch (e) {
        console.error('Google Cloud Translation error:', e);
        return null;
      }
    }

    async function fetchMyMemoryTranslation(text, fromLang, toLang) {
      try {
        const response = await fetch(
          `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${fromLang}|${toLang}`
        );

        if (response.ok) {
          const data = await response.json();
          if (data.responseData) {
            return {
              translatedText: postProcessTranslation(data.responseData.translatedText, text),
              matchScore: data.responseData.match || 0
            };
          }
        }
      } catch (e) {
        console.error('MyMemory error:', e);
        return null;
      }
    }

    function postProcessTranslation(translatedText, originalText) {
      // 1. Preserve capitalization
      if (originalText === originalText.toUpperCase()) {
        translatedText = translatedText.toUpperCase();
      } else if (originalText[0] === originalText[0].toUpperCase()) {
        translatedText = translatedText.charAt(0).toUpperCase() + translatedText.slice(1);
      }

      // 2. Preserve numbers and special characters
      const specialChars = originalText.match(/[0-9$€¥£%°'"@#]/g);
      if (specialChars) {
        specialChars.forEach(char => {
          translatedText = translatedText.replace(new RegExp(`\\${char}`, 'g'), char);
        });
      }

      // 3. Fix punctuation
      translatedText = translatedText
        .replace(/\s+([.,!?;:])/g, '$1')
        .replace(/([a-zA-Z])'([a-zA-Z])/g, '$1\'$2');

      // 4. Preserve line breaks
      if (originalText.includes('\n')) {
        const originalLines = originalText.split('\n');
        const translatedLines = translatedText.split('\n');
        if (originalLines.length === translatedLines.length) {
          translatedText = translatedLines.map((line, i) => {
            if (originalLines[i].trim() === '') return '';
            return line;
          }).join('\n');
        }
      }

      return translatedText;
    }

    function updateQualityIndicator(quality) {
      const indicator = document.getElementById('qualityIndicator');
      const dot = indicator.querySelector('.quality-dot');
      const text = document.getElementById('qualityText');

      indicator.style.display = 'flex';
      dot.className = 'quality-dot';

      switch (quality) {
        case 'good':
          dot.classList.add('good');
          text.textContent = 'Tinggi';
          break;
        case 'fair':
          dot.classList.add('fair');
          text.textContent = 'Sedang';
          break;
        case 'poor':
          dot.classList.add('poor');
          text.textContent = 'Rendah';
          break;
        default:
          indicator.style.display = 'none';
      }
    }

    async function handleTranslate() {
      const input = document.getElementById('translateInput').value.trim();
      const fromLang = document.getElementById('translateFrom').value;
      const toLang = document.getElementById('translateTo').value;
      const output = document.getElementById('translateOutput');
      const translateBtn = document.getElementById('translateBtn');

      if (!input) {
        showTranslatorError('Masukkan teks yang akan diterjemahkan');
        output.innerHTML = '<div style="color: var(--muted);">Terjemahan akan muncul di sini...</div>';
        return;
      }

      showTranslatorError('');
      output.innerHTML = '<div class="translator-loading">Menerjemahkan...</div>';
      translateBtn.disabled = true;
      document.getElementById('qualityIndicator').style.display = 'none';

      try {
        // Optimize for long text
        const MAX_CHARS = 2000;
        if (input.length > MAX_CHARS) {
          output.innerHTML = await translateLongText(input, fromLang, toLang);
        } else {
          const translation = await translateText(input, fromLang, toLang);
          output.innerHTML = translation || input;
        }
      } catch (error) {
        console.error('Translation error:', error);
        showTranslatorError(error.message);
        output.innerHTML = input;
      } finally {
        translateBtn.disabled = false;
      }
    }

    async function translateLongText(text, fromLang, toLang) {
      // Split text into paragraphs
      const paragraphs = text.split(/\n\s*\n/);
      let translatedParagraphs = [];

      for (const paragraph of paragraphs) {
        if (paragraph.trim().length === 0) {
          translatedParagraphs.push('');
          continue;
        }

        // Split into sentences
        const sentences = paragraph.split(/(?<=[.!?])\s+/);
        let translatedSentences = [];

        for (const sentence of sentences) {
          if (sentence.trim().length === 0) continue;

          try {
            const translated = await translateText(sentence, fromLang, toLang);
            translatedSentences.push(translated || sentence);
          } catch (e) {
            translatedSentences.push(sentence);
          }
        }

        translatedParagraphs.push(translatedSentences.join(' '));
      }

      return translatedParagraphs.join('\n\n');
    }

    function swapLanguages() {
      const fromSelect = document.getElementById('translateFrom');
      const toSelect = document.getElementById('translateTo');

      const temp = fromSelect.value;
      fromSelect.value = toSelect.value;
      toSelect.value = temp;

      // Auto translate if there's text
      const input = document.getElementById('translateInput').value.trim();
      if (input) {
        handleTranslate();
      }
    }

    function showTranslatorError(message) {
      const errorEl = document.getElementById('translatorError');
      if (message) {
        errorEl.textContent = message;
        errorEl.style.display = 'block';
      } else {
        errorEl.style.display = 'none';
      }
    }

    // --- Word Management Functions ---
    async function translateWord(word) {
      return translateText(word, 'en', 'id');
    }

    async function addWordFromAPI(input) {
      if (!input.trim()) {
        showError('Masukkan kata yang valid');
        return;
      }

      // Check if input contains comma (manual format: word,translation)
      if (input.includes(',')) {
        const [word, translation] = input.split(',').map(s => s.trim());

        if (!word || !translation) {
          showError('Format manual: kata,terjemahan (contoh: hello,halo)');
          return;
        }

        // Check if word already exists
        const existing = deck.find(card => card.front.toLowerCase() === word.toLowerCase());
        if (existing) {
          showError('Kata sudah ada dalam daftar');
          return;
        }

        const newCard = {
          front: word,
          back: translation,
          id: Date.now(),
          interval: 0,
          repetition: 0,
          ef: 2.5,
          due: todayDate(),
          easeHistory: [],
          history: [],
          category: null
        };

        deck.push(newCard);
        saveToStorage();
        saveToFirestore();
        renderAll();

        // Clear input
        document.getElementById('wordInput').value = '';

        showSuccess(`Berhasil menambahkan: ${word} - ${translation}`);
        return;
      }

      // Auto translation mode
      const word = input.trim();

      // Check if word already exists
      const existing = deck.find(card => card.front.toLowerCase() === word.toLowerCase());
      if (existing) {
        showError('Kata sudah ada dalam daftar');
        return;
      }

      setLoading(true);
      showError(''); // Clear previous errors

      try {
        const translation = await translateWord(word);

        const newCard = {
          front: word,
          back: translation,
          id: Date.now(),
          interval: 0,
          repetition: 0,
          ef: 2.5,
          due: todayDate(),
          easeHistory: [],
          history: [],
          category: null
        };

        deck.push(newCard);
        saveToStorage();
        saveToFirestore();
        renderAll();

        // Clear input
        document.getElementById('wordInput').value = '';

        showSuccess(`Berhasil menambahkan: ${word} - ${translation}`);
      } catch (error) {
        if (error.message === 'Translation not available for this word') {
          showError(`Terjemahan untuk "${word}" tidak tersedia. Gunakan format manual: ${word},terjemahan`);
        } else {
          showError('Gagal menerjemahkan kata. Silakan coba lagi atau gunakan format manual: kata,terjemahan');
        }
      } finally {
        setLoading(false);
      }
    }

    function setLoading(loading) {
      isLoading = loading;
      const addBtn = document.getElementById('addWordBtn');
      const wordInput = document.getElementById('wordInput');

      addBtn.disabled = loading;
      wordInput.disabled = loading;

      if (loading) {
        addBtn.textContent = 'Menerjemahkan...';
        document.body.classList.add('loading');
      } else {
        addBtn.textContent = 'Tambah Kata';
        document.body.classList.remove('loading');
      }
    }

    function showError(message) {
      const errorEl = document.getElementById('errorMessage');
      if (message) {
        errorEl.textContent = message;
        errorEl.style.display = 'block';
      } else {
        errorEl.style.display = 'none';
      }
    }

    function showSuccess(message) {
      // Simple success feedback - you can enhance this
      console.log('Success:', message);
      // Could add a success message element similar to error message
    }

    function rebuildQueue() {
      const t = todayDate();
      queue = deck
        .map((c, idx) => ({
          due: c.due <= t,
          isNew: c.repetition === 0,
          idx
        }))
        .filter(item => item.due)
        .map(x => x.idx);

      // Simple shuffle
      for (let i = queue.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [queue[i], queue[j]] = [queue[j], queue[i]];
      }
    }

    function renderStats() {
      document.getElementById('total').textContent = deck.length;
      document.getElementById('due').textContent = queue.length;
      document.getElementById('new').textContent = deck.filter(c => c.repetition === 0).length;
      document.getElementById('studied').textContent = deck.filter(c => c.history && c.history.length > 0).length;
    }

    function renderList(filter = '') {
      const el = document.getElementById('list');
      el.innerHTML = '';

      const f = filter.trim().toLowerCase();
      const filteredDeck = deck.filter(c =>
        !f || c.front.toLowerCase().includes(f) || c.back.toLowerCase().includes(f)
      );

      if (filteredDeck.length === 0) {
        el.innerHTML = '<div class="empty-state">Tidak ditemukan kosakata</div>';
        return;
      }

      filteredDeck.forEach(c => {
        const actualIndex = deck.findIndex(card => card.id === c.id);
        const div = document.createElement('div');
        div.className = 'list-item';
        div.innerHTML = `
          <div>
            <strong>${c.front}</strong>
            <div class="muted" style="font-size:13px">${c.back}</div>
          </div>
          <div style="display: flex; gap: 8px;">
            <button class="btn-ghost" data-idx="${actualIndex}">Study</button>
            <button class="btn-ghost" data-remove="${actualIndex}" style="background: var(--danger); color: white;">×</button>
          </div>
        `;
        el.appendChild(div);
      });
    }

    function renderDeckPreview() {
      const el = document.getElementById('deckPreviewList');
      el.innerHTML = '';

      if (deck.length === 0) {
        el.innerHTML = '<div class="empty-state">Belum ada kosakata</div>';
        return;
      }

      deck.slice(0, 20).forEach(c => {
        const d = document.createElement('div');
        d.className = 'list-item';
        d.innerHTML = `
          <div>
            <strong>${c.front}</strong>
            <div class="muted">${c.back}</div>
          </div>
        `;
        el.appendChild(d);
      });
    }

    function loadNext() {
      const frontEl = document.getElementById('front');
      const backEl = document.getElementById('back');
      const translationEl = document.getElementById('translation');
      const cardEl = document.getElementById('card');
      const studyPanel = document.getElementById('studyPanel');

      if (queue.length === 0) {
        frontEl.textContent = 'Tidak ada kartu';
        translationEl.textContent = 'Klik "Mulai Belajar" untuk memulai';
        backEl.textContent = '';
        cardEl.classList.remove('flipped');
        current = null;
        studyPanel.style.display = 'none';
        return;
      }

      const idx = queue.shift();
      current = idx;

      frontEl.textContent = deck[idx].front;
      backEl.textContent = deck[idx].front;
      translationEl.textContent = deck[idx].back;
      cardEl.classList.remove('flipped');
      cardEl.classList.add('card-enter');
      studyPanel.style.display = 'grid';

      // Remove animation class after it completes
      setTimeout(() => {
        cardEl.classList.remove('card-enter');
      }, 300);
    }

    function flip() {
      if (current === null) return;
      const cardEl = document.getElementById('card');
      cardEl.classList.toggle('flipped');
    }

    function applySM2(card, score) {
      const now = todayDate();

      if (score < 3) {
        card.repetition = 0;
        card.interval = 1;
        card.ef = Math.max(1.3, card.ef - 0.2);
      } else {
        if (card.repetition === 0) card.interval = 1;
        else if (card.repetition === 1) card.interval = 6;
        else card.interval = Math.round(card.interval * card.ef);

        card.repetition += 1;
        card.ef = Math.max(1.3, card.ef + (0.1 - (5 - score) * (0.08 + (5 - score) * 0.02)));
      }

      // Determine category based on score
      let category;
      if (score === 0) category = 'lupa';
      else if (score === 3) category = 'susah';
      else if (score === 4) category = 'bagus';
      else if (score === 5) category = 'mudah';
      
      card.category = category;
      card.due = new Date(now + card.interval * 24 * 60 * 60 * 1000).getTime();
      card.history = card.history || [];
      card.history.push({ date: Date.now(), score });
      card.easeHistory = card.easeHistory || [];
      card.easeHistory.push(card.ef);

      // Save to both storage and Firestore
      saveToStorage();
      saveToFirestore();
    }

    // --- Review Page Functions ---
    function showReviewPage() {
      document.getElementById('mainPage').style.display = 'none';
      document.getElementById('reviewPage').style.display = 'block';
      renderReviewCategories();
    }

    function showMainPage() {
      document.getElementById('mainPage').style.display = 'block';
      document.getElementById('reviewPage').style.display = 'none';
    }

    function renderReviewCategories() {
      const categoriesEl = document.getElementById('reviewCategories');
      categoriesEl.innerHTML = '';

      // Group cards by their category
      const categorized = {
        lupa: deck.filter(card => card.category === 'lupa'),
        susah: deck.filter(card => card.category === 'susah'),
        bagus: deck.filter(card => card.category === 'bagus'),
        mudah: deck.filter(card => card.category === 'mudah')
      };

      // Create category sections
      const categories = [
        { id: 'lupa', name: 'Lupa', color: 'var(--danger)', cards: categorized.lupa },
        { id: 'susah', name: 'Susah', color: 'var(--warning)', cards: categorized.susah },
        { id: 'bagus', name: 'Bagus', color: 'var(--success)', cards: categorized.bagus },
        { id: 'mudah', name: 'Mudah', color: 'var(--info)', cards: categorized.mudah }
      ];

      categories.forEach(category => {
        const categoryEl = document.createElement('div');
        categoryEl.className = 'review-category';
        categoryEl.innerHTML = `
          <h3 style="color: ${category.color}">
            ${category.name}
            <span class="count">${category.cards.length}</span>
          </h3>
          <div id="${category.id}-list"></div>
        `;
        categoriesEl.appendChild(categoryEl);

        const listEl = document.getElementById(`${category.id}-list`);
        if (category.cards.length === 0) {
          listEl.innerHTML = '<div class="empty-state">Tidak ada kosakata</div>';
        } else {
          category.cards.forEach(card => {
            const itemEl = document.createElement('div');
            itemEl.className = 'review-item';
            itemEl.innerHTML = `
              <div>
                <div class="word">${card.front}</div>
                <div class="translation">${card.back}</div>
              </div>
            `;
            listEl.appendChild(itemEl);
          });
        }
      });
    }

    // --- UI Event Listeners ---
    document.getElementById('search').addEventListener('input', e => {
      renderList(e.target.value);
    });

    document.getElementById('list').addEventListener('click', e => {
      const btn = e.target.closest('button[data-idx]');
      const removeBtn = e.target.closest('button[data-remove]');

      if (removeBtn) {
        const idx = parseInt(removeBtn.dataset.remove);
        if (!isNaN(idx) && confirm('Hapus kata ini dari daftar?')) {
          deck.splice(idx, 1);
          saveToStorage();
          saveToFirestore();
          renderAll();
        }
        return;
      }

      if (!btn) return;

      const idx = parseInt(btn.dataset.idx);
      if (isNaN(idx)) return;

      queue.unshift(idx);
      loadNext();
      renderStats();
    });

    document.getElementById('addWordBtn').addEventListener('click', () => {
      const input = document.getElementById('wordInput').value.trim();
      if (input && !isLoading) {
        addWordFromAPI(input);
      }
    });

    document.getElementById('wordInput').addEventListener('keypress', e => {
      if (e.key === 'Enter' && !isLoading) {
        const input = e.target.value.trim();
        if (input) {
          addWordFromAPI(input);
        }
      }
    });

    document.getElementById('studyNext').addEventListener('click', () => {
      rebuildQueue();
      loadNext();
      renderStats();
    });

    document.getElementById('flip').addEventListener('click', flip);

    document.getElementById('skip').addEventListener('click', () => {
      if (current !== null) {
        queue.push(current);
        current = null;
        loadNext();
        renderStats();
      }
    });

    document.querySelectorAll('.rate-btn').forEach(btn => {
      btn.addEventListener('click', e => {
        if (current === null) return;

        const score = parseInt(e.target.dataset.score);
        applySM2(deck[current], score);
        rebuildQueue();
        loadNext();
        renderStats();
        renderDeckPreview();
      });
    });

    // Review page navigation
    document.getElementById('reviewBtn').addEventListener('click', showReviewPage);
    document.getElementById('backBtn').addEventListener('click', showMainPage);

    // Keyboard shortcuts
    window.addEventListener('keydown', e => {
      if (e.code === 'Space') {
        e.preventDefault();
        flip();
      }
      if (e.key === '1') document.querySelector('.rate-btn.again')?.click();
      if (e.key === '2') document.querySelector('.rate-btn.hard')?.click();
      if (e.key === '3') document.querySelector('.rate-btn.good')?.click();
      if (e.key === '4') document.querySelector('.rate-btn.easy')?.click();
    });

    // CSV Import/Export
    document.getElementById('filein').addEventListener('change', async e => {
      const file = e.target.files[0];
      if (!file) return;

      try {
        const text = await file.text();
        const lines = text.split(/\r?\n/)
          .map(line => line.trim())
          .filter(line => line.length > 0);

        const imported = lines.map((line, i) => {
          const [front, ...backParts] = line.split(',');
          const back = backParts.join(',').trim();
          return {
            front: front.trim(),
            back,
            id: Date.now() + i,
            interval: 0,
            repetition: 0,
            ef: 2.5,
            due: todayDate(),
            easeHistory: [],
            history: [],
            category: null
          };
        }).filter(card => card.front && card.back);

        if (imported.length === 0) {
          alert('Tidak ada data valid yang ditemukan dalam file CSV');
          return;
        }

        deck = imported;
        saveToStorage();
        saveToFirestore();
        rebuildQueue();
        renderAll();
        alert(`Berhasil mengimpor ${imported.length} kosakata!`);
      } catch (err) {
        console.error('Error importing CSV:', err);
        alert('Gagal mengimpor file CSV');
      }
    });

    document.getElementById('export').addEventListener('click', () => {
      const csv = deck.map(c => `${c.front},${c.back}`).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = 'vocabsr_deck.csv';
      a.click();

      setTimeout(() => {
        URL.revokeObjectURL(url);
      }, 100);
    });

    document.getElementById('reset').addEventListener('click', () => {
      if (confirm('Anda yakin ingin mereset semua progres?')) {
        localStorage.removeItem(STORAGE_KEY);
        // Also clear Firestore data
        saveToFirestore().then(() => {
          loadFromStorage();
          rebuildQueue();
          renderAll();
        });
      }
    });

    // Translator Event Listeners
    document.getElementById('translateBtn').addEventListener('click', handleTranslate);
    document.getElementById('swapLanguages').addEventListener('click', swapLanguages);

    // Auto-translate when input changes (with debounce)
    let translateTimeout;
    document.getElementById('translateInput').addEventListener('input', (e) => {
      // Update character counter
      const charCounter = document.getElementById('charCounter');
      charCounter.textContent = `${e.target.value.length}/5000 karakter`;

      clearTimeout(translateTimeout);
      translateTimeout = setTimeout(() => {
        if (e.target.value.trim().length > 0) {
          handleTranslate();
        } else {
          document.getElementById('translateOutput').innerHTML =
            '<div style="color: var(--muted);">Terjemahan akan muncul di sini...</div>';
          document.getElementById('qualityIndicator').style.display = 'none';
        }
      }, 500);
    });

    function renderAll() {
      rebuildQueue();
      renderStats();
      renderList();
      renderDeckPreview();
    }

    // Initialize
    loadFromFirestore(); // Changed from loadFromStorage to loadFromFirestore
    renderAll();

    // Initialize character counter
    document.getElementById('translateInput').addEventListener('focus', () => {
      const input = document.getElementById('translateInput');
      const charCounter = document.getElementById('charCounter');
      charCounter.textContent = `${input.value.length}/5000 karakter`;
    });
  </script>
</body>
</html>